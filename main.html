<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSãƒªãƒ¼ã‚µãƒ«è¨ˆç®—æ©Ÿ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ç”»åƒå‡ºåŠ›æ©Ÿèƒ½ã®ãŸã‚ã«html2canvasã‚’è¿½åŠ  -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* çµæœã®æ£’ã‚°ãƒ©ãƒ•ãŒçµæœã‚¨ãƒªã‚¢å…¨ä½“ã‚’ä½¿ã†ã‚ˆã†ã«ã™ã‚‹ */
        #resultsOutput {
            min-height: 250px; /* ã‚ã‚‹ç¨‹åº¦ã®é«˜ã•ã‚’ç¢ºä¿ */
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        .modal-enter {
            opacity: 0;
        }
        .modal-enter-active {
            opacity: 1;
            transition: opacity 300ms;
        }
        .modal-leave-active {
            opacity: 0;
            transition: opacity 300ms;
        }
        .modal-content-enter {
            transform: scale(0.95);
        }
        .modal-content-enter-active {
            transform: scale(1);
            transition: transform 300ms;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="text-center mb-10 p-4 bg-white rounded-xl shadow-lg">
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’WSãƒªãƒ¼ã‚µãƒ«è¨ˆç®—æ©Ÿ Proã«å¤‰æ›´ -->
            <h1 class="text-3xl font-extrabold text-indigo-700">WSãƒªãƒ¼ã‚µãƒ«è¨ˆç®—æ©Ÿ Pro</h1>
            <p class="text-sm text-gray-600 mt-2">ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢é€£ã¯ä»®å®Ÿè£…ï¼‰</p>
        </header>

        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã‚°ãƒªãƒƒãƒ‰ã«å¤‰æ›´ã—ã€lg:col-spanã§å·¦å³ã«åˆ†å‰² -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- è¨­å®šå…¥åŠ›ã‚¨ãƒªã‚¢ (lg:col-span-1) - ã‚½ãƒ¼ã‚¹ã®é †ç•ªã‚’å…ˆé ­ã«ã—ã€orderã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ -->
            <div class="lg:col-span-1 p-6 bg-white rounded-xl card-shadow h-fit">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
                
                <div class="space-y-4">
                    <!-- åˆæœŸå±±æœ­æšæ•° -->
                    <div>
                        <label for="deckSize" class="block text-sm font-medium text-gray-700">åˆæœŸå±±æœ­æšæ•°</label>
                        <input type="number" id="deckSize" value="28" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- CXæšæ•° -->
                    <div>
                        <label for="cxCount" class="block text-sm font-medium text-gray-700">CXæšæ•°</label>
                        <input type="number" id="cxCount" value="8" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— (èª¬æ˜ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="damages" class="block text-sm font-medium text-gray-700">ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—</label>
                            <button onclick="showExplanationModal()" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 underline">
                                èª¬æ˜ã‚’è¦‹ã‚‹
                            </button>
                        </div>
                        <input type="text" id="damages" value="1,3,3,3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="ä¾‹: 4,3c,2m,3u,1b">
                    </div>

                    <!-- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ON/OFF -->
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="refreshToggle" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="refreshToggle" class="ml-2 block text-sm font-medium text-gray-700">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã‚’é©ç”¨</label>
                    </div>

                    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•° -->
                    <div>
                        <label for="simulations" class="block text-sm font-medium text-gray-700">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°(1000ä»¥ä¸Šã‚’æ¨å¥¨)</label>
                        <input type="number" id="simulations" value="50000" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    
                    <!-- ç”»åƒå‡ºåŠ›æ™‚ã®æœ€å¤§è¡¨ç¤ºç‚¹æ•° (æ–°è¦è¿½åŠ ) -->
                    <div>
                        <label for="imageMaxDamage" class="block text-sm font-medium text-gray-700">ç”»åƒå‡ºåŠ›æ™‚ã®æœ€å¤§è¡¨ç¤ºç‚¹æ•°</label>
                        <input type="number" id="imageMaxDamage" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="ç©ºæ¬„ã§è‡ªå‹•">
                    </div>
                </div>

                <button id="runButton" onclick="handleSimulation()" class="mt-6 w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                </button>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ (lg:col-span-2) - ã‚½ãƒ¼ã‚¹ã®é †ç•ªã‚’2ç•ªç›®ã«ã—ã¦ã€orderã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ -->
            <div class="lg:col-span-2 p-6 bg-white rounded-xl card-shadow">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex justify-between items-center">
                    çµæœ
                    <!-- ç”»åƒå‡ºåŠ›ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
                    <button id="imageOutputButton" onclick="generateImage()" class="text-sm py-1 px-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out hidden">
                        ç”»åƒå‡ºåŠ›
                    </button>
                </h2>
                <!-- é€²è¡ŒçŠ¶æ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ (hiddenã‚‚å‰Šé™¤) -->
                <div id="statusMessage" class="mb-4 text-center text-indigo-600 font-semibold hidden">
                    è¨ˆç®—ä¸­ã§ã™...
                </div>
                
                <!-- â–¼â–¼â–¼ ãƒªãƒ¼ã‚µãƒ«æœŸå¾…å€¤ (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼ -->
                <div id="lethalExpectation" class="mb-5 hidden">
                    <p class="text-sm text-gray-600">ãƒªãƒ¼ã‚µãƒ«æœŸå¾…å€¤ (é€šã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã®å¹³å‡)</p>
                    <p id="expectationValue" class="text-4xl font-extrabold text-indigo-700"></p>
                </div>
                <!-- â–²â–²â–² ãƒªãƒ¼ã‚µãƒ«æœŸå¾…å€¤ (æ–°è¦è¿½åŠ ) â–²â–²â–² -->

                <!-- çµæœã‚°ãƒ©ãƒ•è¡¨ç¤ºé ˜åŸŸ -->
                <div id="resultsOutput" class="space-y-3">
                    <p class="text-gray-500">å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div id="summary" class="mt-6 pt-4 border-t border-gray-200">
                    <p id="summaryText" class="text-sm text-gray-600"></p>
                </div>
            </div>
        </main>
        
        <!-- ç½²åãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="mt-8 text-center text-sm text-gray-500 p-4">
            <p>ãƒ´ã‚¡ã‚¤ã‚¹ã¯ç¢ºç‡ã§ã¯ãªã„ â€“ PineAme@tcepseredutitta</p>
        </footer>
        <!---------------------->

        <!-- ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="explanationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden transition-opacity duration-300 items-center justify-center p-4" onclick="if (event.target === this) closeExplanationModal()">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-indigo-700">ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— å‡¡ä¾‹</h3>
                    <button onclick="closeExplanationModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-gray-700 space-y-3">
                    <p class="font-semibold text-gray-800">å…¥åŠ›å½¢å¼: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¿° (ä¾‹: 4,3c,2m,3u,1b)</p>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li><strong class="font-mono text-indigo-600">N</strong>: Nãƒ€ãƒ¡ãƒ¼ã‚¸ (Nç‚¹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œ)</li>
                        <li><strong class="font-mono text-indigo-600">Nb</strong>: Næšé€†åœ§ç¸® (Næšã®CXã§ãªã„ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã«åŠ ãˆã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«)</li>
                        <li><strong class="font-mono text-indigo-600">Nu</strong>: 1æšãƒˆãƒƒãƒ—ç››ã‚Š + Nãƒ€ãƒ¡ãƒ¼ã‚¸ (CXã§ãªã„ã‚«ãƒ¼ãƒ‰ã‚’ãƒˆãƒƒãƒ—ã«è¿½åŠ å¾Œã€Nãƒ€ãƒ¡ãƒ¼ã‚¸)</li>
                        <li><strong class="font-mono text-indigo-600">Nm</strong>: ãƒ¢ã‚« + Nãƒ€ãƒ¡ãƒ¼ã‚¸ (ãƒˆãƒƒãƒ—2æšæ“ä½œå¾Œã€Nãƒ€ãƒ¡ãƒ¼ã‚¸)</li>
                        <li><strong class="font-mono text-indigo-600">Nc</strong>: ç›´å‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ Nãƒ€ãƒ¡ãƒ¼ã‚¸ (ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãŸå ´åˆã®ã¿Nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œ)</li>
                    </ul>
                </div>
                <button onclick="closeExplanationModal()" class="mt-6 w-full py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        
        <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« (æ–°è¦è¿½åŠ ) -->
        <div id="imagePreviewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden transition-opacity duration-300 items-center justify-center p-4" onclick="if (event.target === this) closeImagePreviewModal()">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="imagePreviewContent" style="max-height: 90vh; display: flex; flex-direction: column;">
                <div class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0">
                    <h3 class="text-xl font-bold text-indigo-700">ç”»åƒç¢ºèª</h3>
                    <button onclick="closeImagePreviewModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="flex-grow overflow-y-auto mb-4 border rounded-lg p-2 bg-gray-50">
                    <img id="previewImage" src="" alt="ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœç”»åƒ" class="w-full h-auto object-contain">
                </div>
                <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                <div class="flex justify-end gap-3 flex-shrink-0">
                    <button onclick="closeImagePreviewModal()" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg shadow hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
                    <button id="downloadButton" class="py-2 px-4 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>

        <!-- ç”»åƒå‡ºåŠ›ç”¨ã®ä¸€æ™‚ã‚³ãƒ³ãƒ†ãƒŠ (éè¡¨ç¤º) -->
        <!-- html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã«ã€å®Œå…¨ã«éè¡¨ç¤ºã§ã¯ãªãç”»é¢å¤–ã«é…ç½® -->
        <div id="imageSourceContainer" class="absolute top-0 left-0" style="z-index: -10; opacity: 0; pointer-events: none; transform: translateX(-1000px);">
            <!-- ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« -->
            <div id="imageSource" style="width: 500px; font-family: 'Inter', sans-serif;">
                <!-- Content will be injected here for image generation -->
            </div>
        </div>

    </div>

    <script>
        // TypeScriptã®å‹ãƒ’ãƒ³ãƒˆã‚’æ¨¡å€£
        /** @typedef {'CX' | 'UnCX'} Card */
        /** @typedef {Object.<number, number>} DamageCounts */
        /** @typedef {Object.<number, number>} CumulativeProbabilities */
        /** @typedef {{
             amount: number, 
             isDamage: boolean, 
             hasMoka: boolean, 
             hasUnCXTop: boolean,
             hasBuryShuffle: boolean,
             hasConditionalCancel: boolean
           }} DamageItem 
        */

        const Card = {
            CX: 'CX',
            UnCX: 'UnCX'
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§æœ€æ–°ã®çµæœã¨è¨­å®šã‚’ä¿æŒ (ç”»åƒå‡ºåŠ›ç”¨)
        let lastProbabilities = null;
        let lastSettings = null;
        let lastExpectation = 0; // æœŸå¾…å€¤ã‚’ä¿æŒ

        // ====================================================================
        // ğŸ› ï¸ è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿é–¢æ•°
        // ====================================================================

        /**
         * ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’localStorageã«ä¿å­˜ã™ã‚‹ã€‚
         */
        function saveSettings() {
            localStorage.setItem('ws_deckSize', document.getElementById('deckSize').value);
            localStorage.setItem('ws_cxCount', document.getElementById('cxCount').value);
            localStorage.setItem('ws_damages', document.getElementById('damages').value);
            localStorage.setItem('ws_simulations', document.getElementById('simulations').value);
            localStorage.setItem('ws_refreshToggle', document.getElementById('refreshToggle').checked);
            localStorage.setItem('ws_imageMaxDamage', document.getElementById('imageMaxDamage').value); 
        }

        /**
         * localStorageã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã¿ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šã™ã‚‹ã€‚
         * æœ€åˆã«å€¤ãŒãªã‘ã‚Œã°ã€HTMLã«è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
         */
        function loadSettings() {
            const deckSizeInput = document.getElementById('deckSize');
            const cxCountInput = document.getElementById('cxCount');
            const damagesInput = document.getElementById('damages');
            const simulationsInput = document.getElementById('simulations');
            const refreshToggleInput = document.getElementById('refreshToggle');
            const imageMaxDamageInput = document.getElementById('imageMaxDamage'); 

            deckSizeInput.value = localStorage.getItem('ws_deckSize') || deckSizeInput.value;
            cxCountInput.value = localStorage.getItem('ws_cxCount') || cxCountInput.value;
            damagesInput.value = localStorage.getItem('ws_damages') || "1,3,3,3";
            simulationsInput.value = localStorage.getItem('ws_simulations') || simulationsInput.value;
            imageMaxDamageInput.value = localStorage.getItem('ws_imageMaxDamage') || imageMaxDamageInput.value; 
            
            const refreshToggleValue = localStorage.getItem('ws_refreshToggle');
            if (refreshToggleValue !== null) {
                refreshToggleInput.checked = refreshToggleValue === 'true';
            }
        }

        // ====================================================================
        // ãƒ´ã‚¡ã‚¤ã‚¹ã‚·ãƒ¥ãƒ´ã‚¡ãƒ«ãƒ„ ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ã‚¯ãƒ©ã‚¹ 
        // ====================================================================

        class WeissDamageSimulator {
            constructor() {
                this.rng = Math; // JavaScriptã®Mathã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¹±æ•°æºã¨ã—ã¦ä½¿ç”¨
                /** @type {Card[]} */
                this.discardPile = []; // æ§ãˆå®¤
            }

            /**
             * å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ï¼ˆãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼ãƒ»ã‚¤ã‚§ãƒ¼ãƒ„ãƒ»ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
             * @param {Card[]} deck 
             */
            _shuffle(deck) {
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
            }

            /**
             * ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã€‚
             * @param {Card[]} deck - ç¾åœ¨ã®å±±æœ­
             * @param {number} totalPassedDamage - ç¾æ™‚ç‚¹ã§ã®ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {[number, Card[]]} - [è¿½åŠ ã•ã‚ŒãŸãƒ€ãƒ¡ãƒ¼ã‚¸, æ–°ã—ã„å±±æœ­]
             */
            _refresh(deck, totalPassedDamage, applyRefreshDamage) {
                // 1. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸(1ç‚¹)
                const addedDamage = applyRefreshDamage ? 1 : 0; // RPè¨­å®šã«å¿œã˜ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ±ºå®š

                // 2. æ§ãˆå®¤ã®ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã«æˆ»ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                deck.push(...this.discardPile);
                this.discardPile = []; // æ§ãˆå®¤ã‚’ç©ºã«ã™ã‚‹
                this._shuffle(deck);

                return [addedDamage, deck];
            }
            
            /**
             * ãƒ¢ã‚«èƒ½åŠ›å‡¦ç†: å±±æœ­ä¸Š2æšã¾ã§è¦‹ã¦CXã‚’æ§ãˆå®¤ã«ç½®ãã€æ®‹ã‚Šã‚’å±±æœ­ãƒˆãƒƒãƒ—ã«æˆ»ã™ã€‚
             * @param {Card[]} currentDeck 
             */
            _processMokaEffect(currentDeck) {
                if (currentDeck.length === 0) return;

                // 1. å±±æœ­ã®ä¸Šã‹ã‚‰2æšã¾ã§è¦‹ã‚‹ï¼ˆå±±æœ­ã‹ã‚‰å–ã‚Šé™¤ãï¼‰
                const revealedCards = currentDeck.splice(0, 2); 
                
                /** @type {Card[]} */
                const cxCards = [];
                /** @type {Card[]} */
                const otherCards = [];

                // 2. CXã¨ãã®ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’åˆ†é¡
                for (const card of revealedCards) {
                    // CXã‚’æ§ãˆå®¤ã«ç½®ã (æœ€å¤§2æšã®CXã‚’æ§å®¤ã¸)
                    if (card === Card.CX && cxCards.length < 2) {
                        cxCards.push(card); 
                    } else {
                        // ãã‚Œä»¥å¤–ã®ã‚«ãƒ¼ãƒ‰ã¯å±±æœ­ãƒˆãƒƒãƒ—ã¸
                        otherCards.push(card); 
                    }
                }

                // 3. CXã‚’æ§ãˆå®¤ã«ç½®ã
                this.discardPile.push(...cxCards);

                // 4. æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã®ä¸Šã«å¥½ããªé †ç•ªã§ç½®ã
                // ãƒ¢ã‚«ã®å ´åˆã€CXä»¥å¤–ãŒãƒ©ãƒ³ãƒ€ãƒ ãªé †ç•ªã§ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ï¼ˆã“ã“ã§ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãªã„ãŸã‚ã€é…åˆ—ã®é †ç•ªé€šã‚Šï¼‰
                this._shuffle(otherCards); // å¿µã®ãŸã‚ã€æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æˆ»ã™ã®ãŒä¸€èˆ¬çš„ã ãŒã€ã“ã“ã§ã¯é…åˆ—ã®é †åºã‚’ç¶­æŒ
                currentDeck.unshift(...otherCards);
            }

            /**
             * UnCXãƒˆãƒƒãƒ—è¿½åŠ å‡¦ç†: å±±æœ­ã®ä¸€ç•ªä¸Šã«æ–°ã—ãCXã§ã¯ãªã„ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã€‚
             * å±±æœ­ã®æšæ•°ãŒ1æšå¢—ãˆã‚‹ã€‚
             * @param {Card[]} currentDeck 
             */
            _processUnCXTopEffect(currentDeck) {
                // å±±æœ­ã®ä¸€ç•ªä¸Šã«UnCXã‚’æŒ¿å…¥
                currentDeck.unshift(Card.UnCX);
            }

            /**
             * UnCXè¿½åŠ ï¼†ã‚·ãƒ£ãƒƒãƒ•ãƒ«å‡¦ç†: æŒ‡å®šæšæ•°ã®UnCXã‚’å±±æœ­ã«åŠ ãˆã€å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã€‚
             * @param {Card[]} currentDeck 
             * @param {number} count - è¿½åŠ ã™ã‚‹UnCXã®æšæ•°
             */
            _processBuryShuffleEffect(currentDeck, count) {
                if (count <= 0) return;
                
                // æŒ‡å®šæšæ•°ã®UnCXã‚’å±±æœ­ã«è¿½åŠ 
                for (let i = 0; i < count; i++) {
                    currentDeck.push(Card.UnCX);
                }

                // å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                this._shuffle(currentDeck);
            }


            /**
             * 1å›ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã€å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¿”ã™ã€‚
             * @param {Card[]} currentDeck - ç¾åœ¨ã®å±±æœ­ï¼ˆã“ã®é–¢æ•°å†…ã§å¤‰æ›´ã•ã‚Œã‚‹ï¼‰
             * @param {number} damageAmount - ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°N
             * @param {number} totalPassedDamage - ç¾æ™‚ç‚¹ã§ã®ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {[number, number, boolean]} - [å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸, ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸, ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã©ã†ã‹]
             */
            _processDamage(currentDeck, damageAmount, totalPassedDamage, applyRefreshDamage) {
                let passedDamage = 0;
                let refreshDamage = 0;
                let isCancelled = false;

                // ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°ï¼ˆdamageAmountï¼‰ã®æœ€å¤§æšæ•°ã¾ã§1æšãšã¤ã‚ãã‚‹
                for (let i = 0; i < damageAmount; i++) {
                    // 1. å±±æœ­ãŒç©ºã«ãªã£ãŸã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†
                    if (currentDeck.length === 0) {
                        // ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
                        const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                        refreshDamage += addedDamage;
                        totalPassedDamage += addedDamage; // ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°
                        currentDeck = newDeck; // å±±æœ­ã‚’æ›´æ–°

                        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã‚‚å±±æœ­ãŒç©ºãªã‚‰ã€ã‚ãã‚‹å‡¦ç†ã‚’çµ‚äº†
                        if (currentDeck.length === 0) {
                            break;
                        }
                    }

                    // 2. å±±æœ­ã®å…ˆé ­ã‹ã‚‰1æšã‚ãã‚Šã€å±±æœ­ã‹ã‚‰å–ã‚Šé™¤ã
                    const drawnCard = currentDeck.shift(); // .shift() ã¯æœ€åˆã®è¦ç´ ã‚’å–ã‚Šé™¤ã

                    // 3. CXãƒã‚§ãƒƒã‚¯: 1æšã§ã‚‚CXãŒå‡ºãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    if (drawnCard === Card.CX) {
                        isCancelled = true;
                        this.discardPile.push(drawnCard);
                        passedDamage = 0;
                        break; // CXãŒå‡ºãŸã®ã§ã€ãã®æ™‚ç‚¹ã§ã‚ãã‚‹ã®ã‚’ã‚¹ãƒˆãƒƒãƒ—
                    }

                    // 4. CXãŒå‡ºãªã‘ã‚Œã°ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒé€šã‚‹
                    passedDamage++;
                    this.discardPile.push(drawnCard); // CXãŒå‡ºãªã‹ã£ãŸã‚«ãƒ¼ãƒ‰ã‚’æ§ãˆå®¤ã¸
                }
                
                // ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ç‚¹ä»¥ä¸Šã§ã€ã‹ã¤å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ã ã£ãŸå ´åˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã¨åˆ¤å®š
                // (damageAmount > 0) ã¯ã€ç©ºå±±æœ­ãªã©ã§å®Ÿè³ªãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã€‚
                const finalCancellationStatus = (damageAmount > 0 && passedDamage === 0);

                return [passedDamage, refreshDamage, finalCancellationStatus];
            }

            /**
             * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°ã”ã¨ã®ç´¯ç©ç¢ºç‡ã‚’è¿”ã™ã€‚
             * @param {number} initialDeckSize 
             * @param {number} cxCount 
             * @param {DamageItem[]} actions 
             * @param {number} simulations 
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {CumulativeProbabilities}
             */
            runSimulation(initialDeckSize, cxCount, actions, simulations, applyRefreshDamage) {
                /** @type {DamageCounts} */
                const damageCounts = {};
                const unCxCount = initialDeckSize - cxCount;
                
                // æœ€å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆè¨ˆï¼‹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸(æœ€å¤§1å›)ã‚’æš«å®šã¨ã™ã‚‹
                const maxPossibleDamage = actions
                    .filter(a => a.isDamage)
                    .reduce((sum, d) => sum + d.amount, 0) + (applyRefreshDamage ? 1 : 0);

                for (let sim = 0; sim < simulations; sim++) {
                    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã®åˆæœŸåŒ–
                    this.discardPile = [];
                    
                    // 1. åˆæœŸå±±æœ­ã®ä½œæˆã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    /** @type {Card[]} */
                    let deck = Array(cxCount).fill(Card.CX).concat(Array(unCxCount).fill(Card.UnCX));
                    this._shuffle(deck);

                    // 2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®å®Ÿè¡Œ
                    let totalPassedDamage = 0;
                    let lastDamageCancelled = false; // ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹
                    
                    let currentDeck = deck; 
                    for (const action of actions) {
                        
                        // 2a. å±±æœ­ã«ã‚«ãƒ¼ãƒ‰ã‚’åŠ ãˆã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Nb)
                        if (action.hasBuryShuffle) {
                            this._processBuryShuffleEffect(currentDeck, action.amount);
                            // Nbã®å ´åˆã€lastDamageCancelled ã®çŠ¶æ…‹ã¯ç¶­æŒã•ã‚Œã‚‹
                            continue; // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã¯è¡Œã‚ãªã„
                        }
                        
                        // 2b. æ¡ä»¶ä»˜ããƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ (Nc)
                        if (action.hasConditionalCancel) {
                            // ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—
                            if (!lastDamageCancelled) {
                                // å®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸå ´åˆã€LDCã¯å¤‰æ›´ã—ãªã„ï¼ˆfalseã®ã¾ã¾ï¼‰
                                continue;
                            }
                            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãŸå ´åˆã€é€šå¸¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ
                            // ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœãŒæ¬¡ã® LDC ã‚’ä¸Šæ›¸ãã—ã¾ã™ (å¾Œç¶šã®å‡¦ç†ã§å®Ÿè¡Œ)ã€‚
                        }
                        
                        // 2c. ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ (N, Nm, Nu, ãŠã‚ˆã³æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸNc)
                        
                        // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†å‰ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ï¼ˆå±±æœ­ãŒç©ºã®å ´åˆï¼‰
                        while (currentDeck.length === 0) {
                            const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                            totalPassedDamage += addedDamage;
                            currentDeck = newDeck;
                            if (currentDeck.length === 0) break; // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã‚‚ç©ºãªã‚‰çµ‚äº†
                        }
                        
                        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ç‰¹æ®Šèƒ½åŠ› (u, m) ã‚’é©ç”¨
                        if (currentDeck.length > 0) { 
                             // UnCXãƒˆãƒƒãƒ—è¿½åŠ èƒ½åŠ›é©ç”¨ãƒã‚§ãƒƒã‚¯
                            if (action.hasUnCXTop) {
                                this._processUnCXTopEffect(currentDeck);
                            }

                            // ãƒ¢ã‚«èƒ½åŠ›é©ç”¨ãƒã‚§ãƒƒã‚¯
                            if (action.hasMoka) {
                                this._processMokaEffect(currentDeck);

                                // ãƒ¢ã‚«èƒ½åŠ›ã§å±±æœ­ãŒç©ºã«ãªã£ãŸå ´åˆã€ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã«å…¥ã‚‹å‰ã«å†åº¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                                while (currentDeck.length === 0) {
                                    const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                                    totalPassedDamage += addedDamage;
                                    currentDeck = newDeck;
                                    if (currentDeck.length === 0) break; 
                                }
                            }
                        }
                        
                        let passedDamage = 0;
                        let refreshAdded = 0;
                        let isCurrentActionCancelled = false;
                        
                        if (currentDeck.length > 0) {
                            // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œ
                            const results = this._processDamage(currentDeck, action.amount, totalPassedDamage, applyRefreshDamage);
                            passedDamage = results[0];
                            refreshAdded = results[1];
                            isCurrentActionCancelled = results[2];
                        } else {
                             // å±±æœ­ãŒç©ºã®å ´åˆã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ã¨ã—ã¦ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã‚’Falseã«è¨­å®š
                             isCurrentActionCancelled = false;
                        }

                        totalPassedDamage += passedDamage;
                        totalPassedDamage += refreshAdded; 

                        // 3. ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœã¨ã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’è¨˜éŒ²
                        // (bä»¥å¤–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãã®çµæœã§ LDC ã‚’ä¸Šæ›¸ãã™ã‚‹)
                        lastDamageCancelled = isCurrentActionCancelled;
                    }

                    // 4. çµæœã®é›†è¨ˆ
                    damageCounts[totalPassedDamage] = (damageCounts[totalPassedDamage] || 0) + 1;
                }

                // 5. ç´¯ç©ç¢ºç‡ã®è¨ˆç®—
                /** @type {CumulativeProbabilities} */
                const cumulativeProbabilities = {};
                
                let cumulativeCount = 0;
                for (let d = maxPossibleDamage; d >= 1; d--) {
                    
                    cumulativeCount += damageCounts[d] || 0;
                    cumulativeProbabilities[d] = cumulativeCount / simulations;
                }

                return cumulativeProbabilities;
            }
        }

        // ====================================================================
        // ğŸš€ UIæ“ä½œã¨å®Ÿè¡Œé–¢æ•°
        // ====================================================================

        const simulator = new WeissDamageSimulator();
        const resultsOutput = document.getElementById('resultsOutput');
        const statusMessage = document.getElementById('statusMessage');
        const runButton = document.getElementById('runButton');
        const summaryText = document.getElementById('summaryText');
        const expectationDiv = document.getElementById('lethalExpectation'); // æœŸå¾…å€¤è¡¨ç¤ºã‚¨ãƒªã‚¢
        const expectationValueText = document.getElementById('expectationValue'); // æœŸå¾…å€¤ã®æ•°å€¤
        
        // Custom message box function (replacing alert)
        function showCustomMessage(message, type = 'info') {
            const alertDiv = document.createElement('div');
            const colorMap = {
                'red': { bg: '#f8d7da', text: '#721c24' },
                'info': { bg: '#d4edda', text: '#155724' }
            };
            const colors = colorMap[type] || colorMap['info'];

            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                padding: 10px 20px; border-radius: 8px; 
                background-color: ${colors.bg}; 
                color: ${colors.text}; 
                box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = 1;
            }, 10);

            setTimeout(() => {
                alertDiv.style.opacity = 0;
                setTimeout(() => document.body.removeChild(alertDiv), 500);
            }, 4000);
        }

        // ----------------------------------------------------
        // ğŸ–¼ï¸ ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        // ----------------------------------------------------
        
        /**
         * ç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹
         * @param {string} base64Image - base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸPNGç”»åƒãƒ‡ãƒ¼ã‚¿URL
         */
        function showImagePreviewModal(base64Image) {
            const modal = document.getElementById('imagePreviewModal');
            const content = document.getElementById('imagePreviewContent');
            const previewImage = document.getElementById('previewImage');
            const downloadButton = document.getElementById('downloadButton');
            
            // ç”»åƒã‚½ãƒ¼ã‚¹ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¨­å®š
            previewImage.src = base64Image;
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã«Base64ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ãŸã‚ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’å†è¨­å®š
            downloadButton.onclick = () => downloadImage(base64Image); 

            modal.classList.remove('hidden');
            modal.classList.add('flex', 'modal-enter'); 
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            setTimeout(() => {
                modal.classList.add('modal-enter-active');
                content.classList.add('modal-content-enter-active');
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            const content = document.getElementById('imagePreviewContent');

            // é€†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            content.classList.remove('modal-content-enter-active');
            content.classList.add('scale-95', 'opacity-0');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'modal-leave-active', 'modal-enter');
            }, 300); 
        }

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         * @param {string} base64Image - base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸPNGç”»åƒãƒ‡ãƒ¼ã‚¿URL
         */
        function downloadImage(base64Image) {
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            link.download = `WS_Lethal_Calc_Result_${timestamp}.png`;
            link.href = base64Image;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showCustomMessage("ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚", 'info');
            closeImagePreviewModal();
        }

        /**
         * ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã®èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showExplanationModal() {
            const modal = document.getElementById('explanationModal');
            const content = document.getElementById('modalContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'modal-enter'); 
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            setTimeout(() => {
                modal.classList.add('modal-enter-active');
                content.classList.add('modal-content-enter-active');
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã®èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closeExplanationModal() {
            const modal = document.getElementById('explanationModal');
            const content = document.getElementById('modalContent');

            // é€†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            content.classList.remove('modal-content-enter-active');
            content.classList.add('scale-95', 'opacity-0');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'modal-leave-active', 'modal-enter');
            }, 300); // Tailwind transition duration
        }
        
        /**
         * çµæœã®ç¢ºç‡ãƒªã‚¹ãƒˆã‚’æ•´å½¢ã—ã¦è¡¨ç¤ºã™ã‚‹
         * (ã‚°ãƒ©ãƒ•è¡¨ç¤ºã¨ç”»åƒå‡ºåŠ›ç”¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°)
         * @param {CumulativeProbabilities} probabilities 
         * @param {number} simulations 
         * @param {number} initialDeckSize 
         * @param {number} cxCount 
         * @param {DamageItem[]} actions 
         * @param {number} timeTaken 
         */
        function displayResults(probabilities, simulations, initialDeckSize, cxCount, actions, timeTaken) {
            resultsOutput.innerHTML = '';
            
            const maxDamageResult = Math.max(...Object.keys(probabilities).map(Number));
            const results = [];
            
            // â–¼â–¼â–¼ æœŸå¾…å€¤ã®è¨ˆç®— (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼
            // ç´¯ç©ç¢ºç‡ã®åˆè¨ˆã¯æœŸå¾…å€¤ã¨ç­‰ã—ã„ (Sum[P(X>=k)] = E[X])
            const expectation = Object.values(probabilities).reduce((sum, prob) => sum + prob, 0);
            expectationDiv.classList.remove('hidden');
            expectationValueText.textContent = `${expectation.toFixed(2)}ç‚¹`;
            // â–²â–²â–² æœŸå¾…å€¤ã®è¨ˆç®— (æ–°è¦è¿½åŠ ) â–²â–²â–²

            // è¡¨ç¤ºç”¨ã®ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—æ–‡å­—åˆ—ã‚’ä½œæˆ
            const damagesString = actions.map(d => {
                if (d.hasBuryShuffle) {
                    return `${d.amount}b`;
                }
                return `${d.amount}${d.hasMoka ? 'm' : ''}${d.hasUnCXTop ? 'u' : ''}${d.hasConditionalCancel ? 'c' : ''}`;
            }).join(', ');
            
            // ç”»åƒå‡ºåŠ›ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            lastProbabilities = probabilities;
            lastSettings = { initialDeckSize, cxCount, damagesString };
            lastExpectation = expectation; // æœŸå¾…å€¤ã‚’ä¿å­˜
            document.getElementById('imageOutputButton').classList.remove('hidden');
            
            // ç”»åƒå‡ºåŠ›ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
            updateImageSource(probabilities, lastSettings, lastExpectation);


            // 1ç‚¹ã‹ã‚‰æœ€å¤§ç‚¹æ•°ã¾ã§è¡¨ç¤º
            for (let d = 1; d <= maxDamageResult; d++) {
                const prob = probabilities[d] || 0.0;
                
                // ãƒãƒ¼ã®è‰²ã¨å¹…ã‚’è¨ˆç®—
                const percentage = (prob * 100).toFixed(2);
                const barWidth = Math.max(parseFloat(percentage), 1); // 0%ã§ã‚‚ãƒãƒ¼ã®ãƒ©ã‚¤ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«æœ€å°1ã‚’è¨­å®š
                
                // å±é™ºåº¦ã‚’è‰²ã§è¡¨ç¾ (ç¢ºç‡ãŒé«˜ã„ã»ã©ç·‘ã€ä½ã„ã»ã©èµ¤ã«åè»¢)
                let barColor;
                if (prob >= 0.8) {
                    barColor = 'bg-green-600'; // 80%ä»¥ä¸Š: ç·‘ (é«˜ç¢ºç‡ = æˆåŠŸ)
                } else if (prob >= 0.5) {
                    barColor = 'bg-yellow-500'; // 50%ä»¥ä¸Š: é»„è‰²
                } else if (prob >= 0.3) {
                    barColor = 'bg-orange-400'; // 30%ä»¥ä¸Š: ã‚ªãƒ¬ãƒ³ã‚¸
                } else {
                    barColor = 'bg-red-500'; // 30%æœªæº€: èµ¤ (ä½ç¢ºç‡ = å¤±æ•—)
                }

                results.push(`
                    <div class="flex items-center space-x-2">
                        <!-- å›ºå®šå¹…w-16ã‚’è¨­å®šã—ã€ã‚°ãƒ©ãƒ•ã®é–‹å§‹ä½ç½®ã‚’æƒãˆã‚‹ -->
                        <span class="font-mono text-sm text-gray-500 flex-shrink-0 whitespace-nowrap w-16">${d}ç‚¹ä»¥ä¸Š</span>
                        <div class="flex-grow bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <!-- transition-all duration-300 ease-out ã¯ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã«ã¯ä¸è¦ã ãŒã€Webè¡¨ç¤ºç”¨ã«ã¯æ®‹ã™ -->
                            <div class="${barColor} h-full rounded-full transition-all duration-300 ease-out" style="width: ${barWidth}%;"></div>
                             <span class="absolute right-0 top-0 bottom-0 pr-2 flex items-center text-xs font-bold text-gray-800">${percentage}%</span>
                        </div>
                       
                    </div>
                `);
            }

            resultsOutput.innerHTML = results.join('');

            summaryText.textContent = `
                è¨­å®šï¼šå±±æœ­${initialDeckSize}æš (CX${cxCount}æš), ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— ${damagesString}ã€‚
                ${simulations}å›ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ ${(timeTaken / 1000).toFixed(3)} ç§’ã§å®Ÿè¡Œã—ã¾ã—ãŸã€‚
            `;
            
        }


        /**
         * ç”»åƒå‡ºåŠ›ç”¨ã®éè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã™ã‚‹ (CSSãƒãƒ¼ã‚°ãƒ©ãƒ•å½¢å¼)
         * @param {CumulativeProbabilities} probabilities 
         * @param {{ initialDeckSize: number, cxCount: number, damagesString: string }} settings 
         * @param {number} expectation - è¨ˆç®—ã•ã‚ŒãŸæœŸå¾…å€¤
         */
        function updateImageSource(probabilities, settings, expectation) {
            const { initialDeckSize, cxCount, damagesString } = settings;
            const imageSource = document.getElementById('imageSource');
            const maxDamageResult = Math.max(...Object.keys(probabilities).map(Number));
            let contentHtml = '';

            // ä¿®æ­£ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã¨è¨­å®šã®è¡¨ç¤ºå½¢å¼
            contentHtml += `
                <div style="font-family: 'Inter', sans-serif; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 1.5rem; font-weight: 800; color: #1f2937; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
                        WSãƒªãƒ¼ã‚µãƒ«è¨ˆç®—æ©Ÿ çµæœ
                    </h3>
                    <div style="font-size: 0.9rem; line-height: 1.5; color: #374151; margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 4px; font-weight: 600; color: #4b5563;">å±±æœ­ï¼š${initialDeckSize}æš(CX${cxCount}æš)</p>
                        <p style="font-weight: 600; color: #4b5563; word-break: break-all;">ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼š${damagesString}</p>
                    </div>
                    
                    <!-- â–¼â–¼â–¼ æœŸå¾…å€¤ã‚’ç”»åƒã«è¿½åŠ  â–¼â–¼â–¼ -->
                    <div style="margin-bottom: 1.5rem;">
                        <p style="font-size: 0.8rem; color: #4b5563;">ãƒªãƒ¼ã‚µãƒ«æœŸå¾…å€¤ (é€šã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã®å¹³å‡)</p>
                        <p style="font-size: 2.2rem; font-weight: 900; color: #4338ca;">${expectation.toFixed(2)}ç‚¹</p>
                    </div>
                    <!-- â–²â–²â–² æœŸå¾…å€¤ã‚’ç”»åƒã«è¿½åŠ  â–²â–²â–² -->

                    <div style="font-size: 1rem; line-height: 1.5; color: #374151; display: flex; flex-direction: column; gap: 8px;">
            `;
            
            // ä¿®æ­£: ç”»åƒå‡ºåŠ›ã®æœ€å¤§è¡¨ç¤ºç‚¹æ•°ã‚’å–å¾—
            const imageMaxDamage = parseInt(document.getElementById('imageMaxDamage').value) || 0;
            const loopLimit = imageMaxDamage > 0 ? imageMaxDamage : maxDamageResult;

            // Data rows
            for (let d = 1; d <= loopLimit; d++) {
                const prob = probabilities[d] || 0.0;
                const percentage = (prob * 100);

                // ä¿®æ­£: æŒ‡å®šã•ã‚ŒãŸæœ€å¤§è¡¨ç¤ºç‚¹æ•°ãŒã‚ã‚‹å ´åˆã¯1%ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–
                if (imageMaxDamage === 0 && percentage <= 1.00) {
                    continue;
                }

                const percentageString = percentage.toFixed(2);
                const barWidth = Math.max(parseFloat(percentage), 1);
                
                // ãƒãƒ¼ã®è‰²ã®æ±ºå®š (Tailwindã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›ã™ã‚‹)
                let barColor;
                if (prob >= 0.8) {
                    barColor = '#059669'; // bg-green-600
                } else if (prob >= 0.5) {
                    barColor = '#f59e0b'; // bg-yellow-500
                } else if (prob >= 0.3) {
                    barColor = '#fb923c'; // bg-orange-400
                } else {
                    barColor = '#ef4444'; // bg-red-500
                }

                // CSSãƒ™ãƒ¼ã‚¹ã®æ£’ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
                contentHtml += `
                    <div style="display: flex; align-items: center; gap: 8px; ">
                        <!-- å›ºå®šå¹…w-16 (64px) ç›¸å½“ -->
                        <span style="font-size: 14px; color: #6b7280; flex-shrink: 0; white-space: nowrap; width: 64px;">${d}ç‚¹ä»¥ä¸Š</span> 
                        <!-- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ -->
                        <div style="flex-grow: 1; background-color: #e5e7eb; border-radius: 9999px; height: 24px; position: relative; overflow: hidden;"> 
                            <!-- ã‚°ãƒ©ãƒ•ãƒãƒ¼ -->
                            <div style="background-color: ${barColor}; height: 100%; border-radius: 9999px; width: ${barWidth}%;"></div>
                            <!-- ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆ -->
                            <span style="position: absolute; right: 0; top: 0; bottom: 0; padding-right: 8px; display: flex; align-items: center; font-size: 12px; font-weight: 700; color: #1f2937;">${percentageString}%</span> 
                        </div>
                    </div>
                `;
            }

            contentHtml += `</div></div>`;
            imageSource.innerHTML = contentHtml;
        }

        /**
         * ç”»åƒå‡ºåŠ›ãƒœã‚¿ãƒ³ã®å‡¦ç†: éè¡¨ç¤ºã®HTMLè¦ç´ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹
         */
        async function generateImage() {
            if (!lastProbabilities || !lastSettings) {
                showCustomMessage("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ç”»åƒã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚", 'red');
                return;
            }
            
            // æœ€æ–°ã®çµæœã§ç”»åƒã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ï¼ˆå¿µã®ãŸã‚å†å®Ÿè¡Œï¼‰
            updateImageSource(lastProbabilities, lastSettings, lastExpectation);

            const sourceElement = document.getElementById('imageSource');
            
            // 1. html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£
            try {
                // showCustomMessage("ç”»åƒã‚’ç”Ÿæˆä¸­ã§ã™...", 'info'); // ğŸ‘ˆ ã“ã®è¡Œã‚’å‰Šé™¤

                const canvas = await html2canvas(sourceElement, {
                    scale: 2, // é«˜è§£åƒåº¦ã§ã‚­ãƒ£ãƒ—ãƒãƒ£
                    useCORS: true,
                    backgroundColor: '#ffffff' // èƒŒæ™¯è‰²ã‚’ç™½ã«è¨­å®š
                });

                // 2. Base64ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const base64Image = canvas.toDataURL("image/png");

                // 3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showImagePreviewModal(base64Image);
                
            } catch (error) {
                console.error("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                showCustomMessage("ç”»åƒã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "red"); 
            }
        }


        /**
         * å…¥åŠ›ã‚’å–å¾—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è¡¨ç¤ºã™ã‚‹
         */
        async function handleSimulation() {
            // ğŸš¨ 1. å…¥åŠ›å€¤ã‚’ä¿å­˜
            saveSettings();
            
            // 2. UIçŠ¶æ…‹ã®æ›´æ–°
            runButton.disabled = true;
            statusMessage.textContent = 'è¨ˆç®—ä¸­ã§ã™... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
            statusMessage.classList.remove('hidden'); // è¨ˆç®—ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç¶­æŒ

            resultsOutput.innerHTML = '';
            summaryText.textContent = '';
            expectationDiv.classList.add('hidden'); // æœŸå¾…å€¤ã‚’éš ã™
            document.getElementById('imageOutputButton').classList.add('hidden'); // ç”»åƒãƒœã‚¿ãƒ³ã‚’éš ã™

            try {
                // 3. å…¥åŠ›ã®å–å¾—ã¨æ¤œè¨¼
                const initialDeckSize = parseInt(document.getElementById('deckSize').value);
                const cxCount = parseInt(document.getElementById('cxCount').value);
                const simulations = parseInt(document.getElementById('simulations').value);
                const applyRefreshDamage = document.getElementById('refreshToggle').checked;
                
                const damagesInput = document.getElementById('damages').value;
                
                /** @type {DamageItem[]} */
                const actions = damagesInput.split(',').map(s => {
                    const trimmed = s.trim();
                    const hasMoka = trimmed.toLowerCase().includes('m');
                    const hasUnCXTop = trimmed.toLowerCase().includes('u');
                    const hasBuryShuffle = trimmed.toLowerCase().includes('b');
                    const hasConditionalCancel = trimmed.toLowerCase().includes('c');
                    
                    // æ•°å­—éƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º
                    const amountStr = trimmed.replace(/[^0-9]/g, ''); 
                    const amount = parseInt(amountStr);
                    
                    if (isNaN(amount) || amount <= 0) return null;

                    // 'b' (Bury) ã¯éãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ãã‚Œä»¥å¤–ã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¡ä»¶ä»˜ãå«ã‚€ï¼‰ã€‚
                    const isDamage = !hasBuryShuffle; 

                    return { amount, isDamage, hasMoka, hasUnCXTop, hasBuryShuffle, hasConditionalCancel };
                }).filter(item => item !== null);

                if (initialDeckSize <= 0 || cxCount < 0 || simulations < 1 || actions.length === 0) {
                    throw new Error("å…¥åŠ›å€¤ãŒä¸æ­£ã§ã™ã€‚æšæ•°ã‚„å›æ•°ã¯æ­£ã®æ•°ã€ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                }
                if (cxCount > initialDeckSize) {
                    throw new Error("CXæšæ•°ãŒåˆæœŸå±±æœ­æšæ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚CXæšæ•°ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
                }

                // 4. è¨ˆç®—å®Ÿè¡Œ
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒå›ºã¾ã‚‰ãªã„ã‚ˆã†ã«éåŒæœŸå‡¦ç†ã‚’æŒŸã‚€
                await new Promise(resolve => setTimeout(resolve, 10)); 

                const startTime = performance.now();
                // RPè¨­å®šã‚’æ¸¡ã™
                const probabilities = simulator.runSimulation(initialDeckSize, cxCount, actions, simulations, applyRefreshDamage);
                const endTime = performance.now();
                
                // 5. çµæœã®è¡¨ç¤º
                displayResults(probabilities, simulations, initialDeckSize, cxCount, actions, endTime - startTime);

            } catch (error) {
                console.error(error);
                resultsOutput.innerHTML = `<div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">${error.message}</div>`;
            } finally {
                // 6. UIçŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
                runButton.disabled = false;
                statusMessage.classList.add('hidden');
            }
        }


        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚: 1. è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        window.onload = () => {
             loadSettings(); // ä¿æŒã—ãŸè¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
             // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®è‡ªå‹•å®Ÿè¡Œã‚’å‰Šé™¤
             // handleSimulation().catch(e => console.log("åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", e));
        };
    </script>
</body>
</html>
