<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ´ã‚¡ã‚¤ã‚¹ã‚·ãƒ¥ãƒ´ã‚¡ãƒ«ãƒ„ ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-indigo-700">ãƒ´ã‚¡ã‚¤ã‚¹ã‚·ãƒ¥ãƒ´ã‚¡ãƒ«ãƒ„ ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-sm text-gray-600 mt-2">ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢é€£ã¯ä»®å®Ÿè£…ï¼‰</p>
        </header>

        <main class="grid grid-cols-1 lg:col-cols-3 gap-8">
            <!-- è¨­å®šå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="lg:col-span-1 p-6 bg-white rounded-xl card-shadow h-fit">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
                
                <div class="space-y-4">
                    <!-- åˆæœŸå±±æœ­æšæ•° -->
                    <div>
                        <label for="deckSize" class="block text-sm font-medium text-gray-700">åˆæœŸå±±æœ­æšæ•°</label><!-- (Deck Size)ã‚’å‰Šé™¤ -->
                        <input type="number" id="deckSize" value="28" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- CXæšæ•° -->
                    <div>
                        <label for="cxCount" class="block text-sm font-medium text-gray-700">CXæšæ•°</label><!-- (Climax Count)ã‚’å‰Šé™¤ -->
                        <input type="number" id="cxCount" value="8" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— (èª¬æ˜ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="damages" class="block text-sm font-medium text-gray-700">ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—</label>
                            <button onclick="showExplanationModal()" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 underline">
                                èª¬æ˜ã‚’è¦‹ã‚‹
                            </button>
                        </div>
                        <input type="text" id="damages" value="1,3,3,3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="ä¾‹: 4,3c,2m,3u,1b">
                    </div>

                    <!-- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ON/OFF -->
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="refreshToggle" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="refreshToggle" class="ml-2 block text-sm font-medium text-gray-700">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã‚’é©ç”¨</label>
                    </div>

                    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•° -->
                    <div>
                        <label for="simulations" class="block text-sm font-medium text-gray-700">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°</label>
                        <input type="number" id="simulations" value="50000" min="1000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>

                <button id="runButton" onclick="handleSimulation()" class="mt-6 w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                </button>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="lg:col-span-2 p-6 bg-white rounded-xl card-shadow">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">çµæœ</h2>
                <div id="statusMessage" class="mb-4 text-center text-indigo-600 font-semibold hidden">
                    è¨ˆç®—ä¸­ã§ã™...
                </div>
                
                <div id="resultsOutput" class="space-y-3">
                    <p class="text-gray-500">å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div id="summary" class="mt-6 pt-4 border-t border-gray-200">
                    <p id="summaryText" class="text-sm text-gray-600"></p>
                </div>
            </div>
        </main>
        
        <!-- ç½²åãƒ•ãƒƒã‚¿ãƒ¼ã®è¿½åŠ  -->
        <footer class="mt-8 text-center text-sm text-gray-500 p-4">
            <p>Thanks for visiting! â€“ PineAme@tcepseredutitta</p>
        </footer>
        <!---------------------->

        <!-- ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="explanationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden transition-opacity duration-300 items-center justify-center p-4" onclick="if (event.target === this) closeExplanationModal()">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-indigo-700">ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— å‡¡ä¾‹</h3>
                    <button onclick="closeExplanationModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-gray-700 space-y-3">
                    <p class="font-semibold text-gray-800">å…¥åŠ›å½¢å¼: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¿° (ä¾‹: 1,2u,3u,4m,5c)</p>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li><strong class="font-mono text-indigo-600">N</strong>: Nãƒ€ãƒ¡ãƒ¼ã‚¸ (Nç‚¹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œ)</li>
                        <li><strong class="font-mono text-indigo-600">Nb</strong>: Næšé€†åœ§ç¸® (Næšã®CXã§ãªã„ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã«åŠ ãˆã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«)</li>
                        <li><strong class="font-mono text-indigo-600">Nu</strong>: 1æšãƒˆãƒƒãƒ—ç››ã‚Š + Nãƒ€ãƒ¡ãƒ¼ã‚¸ (CXã§ãªã„ã‚«ãƒ¼ãƒ‰ã‚’ãƒˆãƒƒãƒ—ã«è¿½åŠ å¾Œã€Nãƒ€ãƒ¡ãƒ¼ã‚¸)</li>
                        <li><strong class="font-mono text-indigo-600">Nm</strong>: ãƒ¢ã‚« + Nãƒ€ãƒ¡ãƒ¼ã‚¸ (ãƒˆãƒƒãƒ—2æšæ“ä½œå¾Œã€Nãƒ€ãƒ¡ãƒ¼ã‚¸)</li>
                        <li><strong class="font-mono text-indigo-600">Nc</strong>: ç›´å‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ Nãƒ€ãƒ¡ãƒ¼ã‚¸ (ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãŸå ´åˆã®ã¿Nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œ)</li>
                    </ul>
                </div>
                <button onclick="closeExplanationModal()" class="mt-6 w-full py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">é–‰ã˜ã‚‹</button>
            </div>
        </div>

    </div>

    <script>
        // TypeScriptã®å‹ãƒ’ãƒ³ãƒˆã‚’æ¨¡å€£
        /** @typedef {'CX' | 'UnCX'} Card */
        /** @typedef {Object.<number, number>} DamageCounts */
        /** @typedef {Object.<number, number>} CumulativeProbabilities */
        /** @typedef {{
             amount: number, 
             isDamage: boolean, 
             hasMoka: boolean, 
             hasUnCXTop: boolean,
             hasBuryShuffle: boolean,
             hasConditionalCancel: boolean // æ¡ä»¶ä»˜ããƒ€ãƒ¡ãƒ¼ã‚¸(c)ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
           }} DamageItem 
        */

        const Card = {
            CX: 'CX',
            UnCX: 'UnCX'
        };
        
        // ====================================================================
        // ğŸ› ï¸ è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿é–¢æ•°
        // ====================================================================

        /**
         * ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’localStorageã«ä¿å­˜ã™ã‚‹ã€‚
         */
        function saveSettings() {
            localStorage.setItem('ws_deckSize', document.getElementById('deckSize').value);
            localStorage.setItem('ws_cxCount', document.getElementById('cxCount').value);
            localStorage.setItem('ws_damages', document.getElementById('damages').value);
            localStorage.setItem('ws_simulations', document.getElementById('simulations').value);
            localStorage.setItem('ws_refreshToggle', document.getElementById('refreshToggle').checked);
        }

        /**
         * localStorageã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã¿ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šã™ã‚‹ã€‚
         * æœ€åˆã«å€¤ãŒãªã‘ã‚Œã°ã€HTMLã«è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
         */
        function loadSettings() {
            const deckSizeInput = document.getElementById('deckSize');
            const cxCountInput = document.getElementById('cxCount');
            const damagesInput = document.getElementById('damages');
            const simulationsInput = document.getElementById('simulations');
            const refreshToggleInput = document.getElementById('refreshToggle');

            deckSizeInput.value = localStorage.getItem('ws_deckSize') || deckSizeInput.value;
            cxCountInput.value = localStorage.getItem('ws_cxCount') || cxCountInput.value;
            // åˆæœŸå€¤ã‚’1,3,3,3ã«è¨­å®š (ä¿®æ­£æ¸ˆã¿)
            damagesInput.value = localStorage.getItem('ws_damages') || "1,3,3,3";
            simulationsInput.value = localStorage.getItem('ws_simulations') || simulationsInput.value;
            
            const refreshToggleValue = localStorage.getItem('ws_refreshToggle');
            if (refreshToggleValue !== null) {
                refreshToggleInput.checked = refreshToggleValue === 'true';
            }
        }

        // ====================================================================
        // ãƒ´ã‚¡ã‚¤ã‚¹ã‚·ãƒ¥ãƒ´ã‚¡ãƒ«ãƒ„ ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ã‚¯ãƒ©ã‚¹ 
        // ====================================================================

        class WeissDamageSimulator {
            constructor() {
                this.rng = Math; // JavaScriptã®Mathã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¹±æ•°æºã¨ã—ã¦ä½¿ç”¨
                /** @type {Card[]} */
                this.discardPile = []; // æ§ãˆå®¤
            }

            /**
             * å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ï¼ˆãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼ãƒ»ã‚¤ã‚§ãƒ¼ãƒ„ãƒ»ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
             * @param {Card[]} deck 
             */
            _shuffle(deck) {
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
            }

            /**
             * ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã€‚
             * @param {Card[]} deck - ç¾åœ¨ã®å±±æœ­
             * @param {number} totalPassedDamage - ç¾æ™‚ç‚¹ã§ã®ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {[number, Card[]]} - [è¿½åŠ ã•ã‚ŒãŸãƒ€ãƒ¡ãƒ¼ã‚¸, æ–°ã—ã„å±±æœ­]
             */
            _refresh(deck, totalPassedDamage, applyRefreshDamage) {
                // 1. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸(1ç‚¹)
                const addedDamage = applyRefreshDamage ? 1 : 0; // RPè¨­å®šã«å¿œã˜ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ±ºå®š

                // 2. æ§ãˆå®¤ã®ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã«æˆ»ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                deck.push(...this.discardPile);
                this.discardPile = []; // æ§ãˆå®¤ã‚’ç©ºã«ã™ã‚‹
                this._shuffle(deck);

                return [addedDamage, deck];
            }
            
            /**
             * ãƒ¢ã‚«èƒ½åŠ›å‡¦ç†: å±±æœ­ä¸Š2æšã¾ã§è¦‹ã¦CXã‚’æ§ãˆå®¤ã«ç½®ãã€æ®‹ã‚Šã‚’å±±æœ­ãƒˆãƒƒãƒ—ã«æˆ»ã™ã€‚
             * @param {Card[]} currentDeck 
             */
            _processMokaEffect(currentDeck) {
                if (currentDeck.length === 0) return;

                // 1. å±±æœ­ã®ä¸Šã‹ã‚‰2æšã¾ã§è¦‹ã‚‹ï¼ˆå±±æœ­ã‹ã‚‰å–ã‚Šé™¤ãï¼‰
                const revealedCards = currentDeck.splice(0, 2); 
                
                /** @type {Card[]} */
                const cxCards = [];
                /** @type {Card[]} */
                const otherCards = [];

                // 2. CXã¨ãã®ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’åˆ†é¡
                for (const card of revealedCards) {
                    if (card === Card.CX && cxCards.length < 2) {
                        cxCards.push(card); // æœ€å¤§2æšã®CXã‚’æ§å®¤ã¸
                    } else {
                        otherCards.push(card); // ãã‚Œä»¥å¤–ã®ã‚«ãƒ¼ãƒ‰ã¯å±±æœ­ãƒˆãƒƒãƒ—ã¸
                    }
                }

                // 3. CXã‚’æ§ãˆå®¤ã«ç½®ã
                this.discardPile.push(...cxCards);

                // 4. æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã®ä¸Šã«å¥½ããªé †ç•ªã§ç½®ã
                currentDeck.unshift(...otherCards);
            }

            /**
             * UnCXãƒˆãƒƒãƒ—è¿½åŠ å‡¦ç†: å±±æœ­ã®ä¸€ç•ªä¸Šã«æ–°ã—ãCXã§ã¯ãªã„ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã€‚
             * å±±æœ­ã®æšæ•°ãŒ1æšå¢—ãˆã‚‹ã€‚
             * @param {Card[]} currentDeck 
             */
            _processUnCXTopEffect(currentDeck) {
                // å±±æœ­ã®ä¸€ç•ªä¸Šã«UnCXã‚’æŒ¿å…¥
                currentDeck.unshift(Card.UnCX);
            }

            /**
             * UnCXè¿½åŠ ï¼†ã‚·ãƒ£ãƒƒãƒ•ãƒ«å‡¦ç†: æŒ‡å®šæšæ•°ã®UnCXã‚’å±±æœ­ã«åŠ ãˆã€å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã€‚
             * @param {Card[]} currentDeck 
             * @param {number} count - è¿½åŠ ã™ã‚‹UnCXã®æšæ•°
             */
            _processBuryShuffleEffect(currentDeck, count) {
                if (count <= 0) return;
                
                // æŒ‡å®šæšæ•°ã®UnCXã‚’å±±æœ­ã«è¿½åŠ 
                for (let i = 0; i < count; i++) {
                    currentDeck.push(Card.UnCX);
                }

                // å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                this._shuffle(currentDeck);
            }


            /**
             * 1å›ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã€å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¿”ã™ã€‚
             * @param {Card[]} currentDeck - ç¾åœ¨ã®å±±æœ­ï¼ˆã“ã®é–¢æ•°å†…ã§å¤‰æ›´ã•ã‚Œã‚‹ï¼‰
             * @param {number} damageAmount - ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°N
             * @param {number} totalPassedDamage - ç¾æ™‚ç‚¹ã§ã®ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {[number, number, boolean]} - [å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸, ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸, ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã©ã†ã‹]
             */
            _processDamage(currentDeck, damageAmount, totalPassedDamage, applyRefreshDamage) {
                let passedDamage = 0;
                let refreshDamage = 0;
                let isCancelled = false;

                // ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°ï¼ˆdamageAmountï¼‰ã®æœ€å¤§æšæ•°ã¾ã§1æšãšã¤ã‚ãã‚‹
                for (let i = 0; i < damageAmount; i++) {
                    // 1. å±±æœ­ãŒç©ºã«ãªã£ãŸã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†
                    if (currentDeck.length === 0) {
                        // ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
                        const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                        refreshDamage += addedDamage;
                        totalPassedDamage += addedDamage; // ç´¯ç©ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°
                        currentDeck = newDeck; // å±±æœ­ã‚’æ›´æ–°

                        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã‚‚å±±æœ­ãŒç©ºãªã‚‰ã€ã‚ãã‚‹å‡¦ç†ã‚’çµ‚äº†
                        if (currentDeck.length === 0) {
                            break;
                        }
                    }

                    // 2. å±±æœ­ã®å…ˆé ­ã‹ã‚‰1æšã‚ãã‚Šã€å±±æœ­ã‹ã‚‰å–ã‚Šé™¤ã
                    const drawnCard = currentDeck.shift(); // .shift() ã¯æœ€åˆã®è¦ç´ ã‚’å–ã‚Šé™¤ã

                    // 3. CXãƒã‚§ãƒƒã‚¯: 1æšã§ã‚‚CXãŒå‡ºãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    if (drawnCard === Card.CX) {
                        isCancelled = true;
                        this.discardPile.push(drawnCard);
                        passedDamage = 0;
                        break; // CXãŒå‡ºãŸã®ã§ã€ãã®æ™‚ç‚¹ã§ã‚ãã‚‹ã®ã‚’ã‚¹ãƒˆãƒƒãƒ—
                    }

                    // 4. CXãŒå‡ºãªã‘ã‚Œã°ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒé€šã‚‹
                    passedDamage++;
                    this.discardPile.push(drawnCard); // CXãŒå‡ºãªã‹ã£ãŸã‚«ãƒ¼ãƒ‰ã‚’æ§ãˆå®¤ã¸
                }
                
                // ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ç‚¹ä»¥ä¸Šã§ã€ã‹ã¤å®Ÿéš›ã«é€šã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ã ã£ãŸå ´åˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã¨åˆ¤å®š
                // (damageAmount > 0) ã¯ã€ç©ºå±±æœ­ãªã©ã§å®Ÿè³ªãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã€‚
                const finalCancellationStatus = (damageAmount > 0 && passedDamage === 0);

                return [passedDamage, refreshDamage, finalCancellationStatus];
            }

            /**
             * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ç‚¹æ•°ã”ã¨ã®ç´¯ç©ç¢ºç‡ã‚’è¿”ã™ã€‚
             * @param {number} initialDeckSize 
             * @param {number} cxCount 
             * @param {DamageItem[]} actions 
             * @param {number} simulations 
             * @param {boolean} applyRefreshDamage - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã™ã‚‹ã‹ã©ã†ã‹
             * @returns {CumulativeProbabilities}
             */
            runSimulation(initialDeckSize, cxCount, actions, simulations, applyRefreshDamage) {
                /** @type {DamageCounts} */
                const damageCounts = {};
                const unCxCount = initialDeckSize - cxCount;
                
                // æœ€å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆè¨ˆï¼‹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ€ãƒ¡ãƒ¼ã‚¸(æœ€å¤§1å›)ã‚’æš«å®šã¨ã™ã‚‹
                const maxPossibleDamage = actions
                    .filter(a => a.isDamage)
                    .reduce((sum, d) => sum + d.amount, 0) + (applyRefreshDamage ? 1 : 0);

                for (let sim = 0; sim < simulations; sim++) {
                    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã®åˆæœŸåŒ–
                    this.discardPile = [];
                    
                    // 1. åˆæœŸå±±æœ­ã®ä½œæˆã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    /** @type {Card[]} */
                    let deck = Array(cxCount).fill(Card.CX).concat(Array(unCxCount).fill(Card.UnCX));
                    this._shuffle(deck);

                    // 2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®å®Ÿè¡Œ
                    let totalPassedDamage = 0;
                    let lastDamageCancelled = false; // ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹
                    
                    let currentDeck = deck; 
                    for (const action of actions) {
                        
                        // 2a. å±±æœ­ã«ã‚«ãƒ¼ãƒ‰ã‚’åŠ ãˆã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Nb)
                        if (action.hasBuryShuffle) {
                            this._processBuryShuffleEffect(currentDeck, action.amount);
                            // Nbã®å ´åˆã€lastDamageCancelled ã®çŠ¶æ…‹ã¯ç¶­æŒã•ã‚Œã‚‹
                            continue; // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã¯è¡Œã‚ãªã„
                        }
                        
                        // 2b. æ¡ä»¶ä»˜ããƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ (Nc)
                        if (action.hasConditionalCancel) {
                            // ç›´å‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—
                            if (!lastDamageCancelled) {
                                // å®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸå ´åˆã€LDCã¯å¤‰æ›´ã—ãªã„ï¼ˆfalseã®ã¾ã¾ï¼‰
                                continue;
                            }
                            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ãŸå ´åˆã€é€šå¸¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ
                            // ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœãŒæ¬¡ã® LDC ã‚’ä¸Šæ›¸ãã—ã¾ã™ (å¾Œç¶šã®å‡¦ç†ã§å®Ÿè¡Œ)ã€‚
                        }
                        
                        // 2c. ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ (N, Nm, Nu, ãŠã‚ˆã³æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸNc)
                        
                        // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†å‰ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ï¼ˆå±±æœ­ãŒç©ºã®å ´åˆï¼‰
                        while (currentDeck.length === 0) {
                            const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                            totalPassedDamage += addedDamage;
                            currentDeck = newDeck;
                            if (currentDeck.length === 0) break; // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã‚‚ç©ºãªã‚‰çµ‚äº†
                        }
                        
                        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ç‰¹æ®Šèƒ½åŠ› (u, m) ã‚’é©ç”¨
                        if (currentDeck.length > 0) { 
                             // UnCXãƒˆãƒƒãƒ—è¿½åŠ èƒ½åŠ›é©ç”¨ãƒã‚§ãƒƒã‚¯
                            if (action.hasUnCXTop) {
                                this._processUnCXTopEffect(currentDeck);
                            }

                            // ãƒ¢ã‚«èƒ½åŠ›é©ç”¨ãƒã‚§ãƒƒã‚¯
                            if (action.hasMoka) {
                                this._processMokaEffect(currentDeck);

                                // ãƒ¢ã‚«èƒ½åŠ›ã§å±±æœ­ãŒç©ºã«ãªã£ãŸå ´åˆã€ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã«å…¥ã‚‹å‰ã«å†åº¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                                while (currentDeck.length === 0) {
                                    const [addedDamage, newDeck] = this._refresh(currentDeck, totalPassedDamage, applyRefreshDamage);
                                    totalPassedDamage += addedDamage;
                                    currentDeck = newDeck;
                                    if (currentDeck.length === 0) break; 
                                }
                            }
                        }
                        
                        let passedDamage = 0;
                        let refreshAdded = 0;
                        let isCurrentActionCancelled = false;
                        
                        if (currentDeck.length > 0) {
                            // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œ
                            const results = this._processDamage(currentDeck, action.amount, totalPassedDamage, applyRefreshDamage);
                            passedDamage = results[0];
                            refreshAdded = results[1];
                            isCurrentActionCancelled = results[2];
                        } else {
                             // å±±æœ­ãŒç©ºã®å ´åˆã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ã¨ã—ã¦ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã‚’Falseã«è¨­å®š
                             isCurrentActionCancelled = false;
                        }

                        totalPassedDamage += passedDamage;
                        totalPassedDamage += refreshAdded; 

                        // 3. ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœã¨ã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’è¨˜éŒ²
                        // (bä»¥å¤–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãã®çµæœã§ LDC ã‚’ä¸Šæ›¸ãã™ã‚‹)
                        lastDamageCancelled = isCurrentActionCancelled;
                    }

                    // 4. çµæœã®é›†è¨ˆ
                    damageCounts[totalPassedDamage] = (damageCounts[totalPassedDamage] || 0) + 1;
                }

                // 5. ç´¯ç©ç¢ºç‡ã®è¨ˆç®—
                /** @type {CumulativeProbabilities} */
                const cumulativeProbabilities = {};
                
                let cumulativeCount = 0;
                for (let d = maxPossibleDamage; d >= 1; d--) {
                    
                    cumulativeCount += damageCounts[d] || 0;
                    cumulativeProbabilities[d] = cumulativeCount / simulations;
                }

                return cumulativeProbabilities;
            }
        }

        // ====================================================================
        // ğŸš€ UIæ“ä½œã¨å®Ÿè¡Œé–¢æ•°
        // ====================================================================

        const simulator = new WeissDamageSimulator();
        const resultsOutput = document.getElementById('resultsOutput');
        const statusMessage = document.getElementById('statusMessage');
        const runButton = document.getElementById('runButton');
        const summaryText = document.getElementById('summaryText');

        /**
         * ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã®èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showExplanationModal() {
            const modal = document.getElementById('explanationModal');
            const content = document.getElementById('modalContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'opacity-0'); // hiddenã‚’å‰Šé™¤ã—ã€flexã‚’è¿½åŠ ã—ã¦è¡¨ç¤º
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã®èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closeExplanationModal() {
            const modal = document.getElementById('explanationModal');
            const content = document.getElementById('modalContent');

            // é€†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
            content.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300); // Tailwind transition duration
        }


        /**
         * å…¥åŠ›ã‚’å–å¾—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è¡¨ç¤ºã™ã‚‹
         */
        async function handleSimulation() {
            // ğŸš¨ 1. å…¥åŠ›å€¤ã‚’ä¿å­˜
            saveSettings();
            
            // 2. UIçŠ¶æ…‹ã®æ›´æ–°
            runButton.disabled = true;
            statusMessage.textContent = 'è¨ˆç®—ä¸­ã§ã™... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
            statusMessage.classList.remove('hidden');
            resultsOutput.innerHTML = '';
            summaryText.textContent = '';

            try {
                // 3. å…¥åŠ›ã®å–å¾—ã¨æ¤œè¨¼
                const initialDeckSize = parseInt(document.getElementById('deckSize').value);
                const cxCount = parseInt(document.getElementById('cxCount').value);
                const simulations = parseInt(document.getElementById('simulations').value);
                const applyRefreshDamage = document.getElementById('refreshToggle').checked;
                
                const damagesInput = document.getElementById('damages').value;
                
                /** @type {DamageItem[]} */
                const actions = damagesInput.split(',').map(s => {
                    const trimmed = s.trim();
                    const hasMoka = trimmed.toLowerCase().includes('m');
                    const hasUnCXTop = trimmed.toLowerCase().includes('u');
                    const hasBuryShuffle = trimmed.toLowerCase().includes('b');
                    const hasConditionalCancel = trimmed.toLowerCase().includes('c'); // <-- è¿½åŠ 
                    
                    // æ•°å­—éƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º
                    const amountStr = trimmed.replace(/[^0-9]/g, ''); 
                    const amount = parseInt(amountStr);
                    
                    if (isNaN(amount) || amount <= 0) return null;

                    // 'b' (Bury) ã¯éãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ãã‚Œä»¥å¤–ã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¡ä»¶ä»˜ãå«ã‚€ï¼‰ã€‚
                    const isDamage = !hasBuryShuffle; 

                    return { amount, isDamage, hasMoka, hasUnCXTop, hasBuryShuffle, hasConditionalCancel };
                }).filter(item => item !== null);

                if (initialDeckSize <= 0 || cxCount < 0 || simulations < 1000 || actions.length === 0) {
                    throw new Error("å…¥åŠ›å€¤ãŒä¸æ­£ã§ã™ã€‚æšæ•°ã‚„å›æ•°ã¯æ­£ã®æ•°ã€ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                }
                if (cxCount > initialDeckSize) {
                    throw new Error("CXæšæ•°ãŒåˆæœŸå±±æœ­æšæ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚CXæšæ•°ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
                }

                // 4. è¨ˆç®—å®Ÿè¡Œ
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒå›ºã¾ã‚‰ãªã„ã‚ˆã†ã«éåŒæœŸå‡¦ç†ã‚’æŒŸã‚€
                await new Promise(resolve => setTimeout(resolve, 10)); 

                const startTime = performance.now();
                // RPè¨­å®šã‚’æ¸¡ã™
                const probabilities = simulator.runSimulation(initialDeckSize, cxCount, actions, simulations, applyRefreshDamage);
                const endTime = performance.now();
                
                // 5. çµæœã®è¡¨ç¤º
                displayResults(probabilities, simulations, initialDeckSize, cxCount, actions, endTime - startTime);

            } catch (error) {
                console.error(error);
                resultsOutput.innerHTML = `<div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">${error.message}</div>`;
            } finally {
                // 6. UIçŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
                runButton.disabled = false;
                statusMessage.classList.add('hidden');
            }
        }

        /**
         * çµæœã®ç¢ºç‡ãƒªã‚¹ãƒˆã‚’æ•´å½¢ã—ã¦è¡¨ç¤ºã™ã‚‹
         * @param {CumulativeProbabilities} probabilities 
         * @param {number} simulations 
         * @param {number} initialDeckSize 
         * @param {number} cxCount 
         * @param {DamageItem[]} actions 
         * @param {number} timeTaken 
         */
        function displayResults(probabilities, simulations, initialDeckSize, cxCount, actions, timeTaken) {
            resultsOutput.innerHTML = '';
            
            const maxDamageResult = Math.max(...Object.keys(probabilities).map(Number));
            const results = [];
            
            // è¡¨ç¤ºç”¨ã®ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ—æ–‡å­—åˆ—ã‚’ä½œæˆ
            const damagesString = actions.map(d => {
                if (d.hasBuryShuffle) {
                    return `${d.amount}b`;
                }
                return `${d.amount}${d.hasMoka ? 'm' : ''}${d.hasUnCXTop ? 'u' : ''}${d.hasConditionalCancel ? 'c' : ''}`; // <-- æ›´æ–°
            }).join(', ');

            // 1ç‚¹ã‹ã‚‰æœ€å¤§ç‚¹æ•°ã¾ã§è¡¨ç¤º
            for (let d = 1; d <= maxDamageResult; d++) {
                const prob = probabilities[d] || 0.0;
                
                // ãƒãƒ¼ã®è‰²ã¨å¹…ã‚’è¨ˆç®—
                const percentage = (prob * 100).toFixed(2);
                const barWidth = Math.max(percentage, 1); // 0%ã§ã‚‚ãƒãƒ¼ã®ãƒ©ã‚¤ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«æœ€å°1ã‚’è¨­å®š
                const barColor = prob >= 0.7 ? 'bg-green-500' : prob >= 0.4 ? 'bg-yellow-500' : 'bg-red-500';

                results.push(`
                    <div class="flex items-center space-x-2">
                        <span class="font-mono text-sm w-12 text-gray-500">${d}ç‚¹ä»¥ä¸Š:</span>
                        <div class="flex-grow bg-gray-200 rounded-full h-4">
                            <div class="${barColor} h-4 rounded-full" style="width: ${barWidth}%;"></div>
                        </div>
                        <span class="font-semibold w-16 text-right">${percentage}%</span>
                    </div>
                `);
            }

            resultsOutput.innerHTML = results.join('');

            summaryText.textContent = `
                è¨­å®šï¼šå±±æœ­${initialDeckSize}æš (CX${cxCount}æš), ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ— ${damagesString}ã€‚
                ${simulations}å›ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ ${(timeTaken / 1000).toFixed(3)} ç§’ã§å®Ÿè¡Œã—ã¾ã—ãŸã€‚
            `;
            
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚: 1. è¨­å®šã‚’èª­ã¿è¾¼ã‚€ -> 2. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•å®Ÿè¡Œã™ã‚‹
        window.onload = () => {
             loadSettings(); // ä¿æŒã—ãŸè¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
             handleSimulation().catch(e => console.log("åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", e));
        };
    </script>
</body>
</html>
