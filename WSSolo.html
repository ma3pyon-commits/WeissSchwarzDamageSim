<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSSolo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* カスタムラジオボタンのスタイル（狭く表示するための調整） */
        .location-radio-group label {
            cursor: pointer;
            padding: 2px 5px; /* 狭く */
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
            font-size: 0.6rem; /* わずかに小さく */
            line-height: 1rem;
            border: 1px solid #e5e7eb; /* gray-200 */
            white-space: nowrap; /* 折り返しを防ぐ */
        }
        .location-radio-group input[type="radio"] {
            display: none;
        }
        .location-radio-group input[type="radio"]:checked + label {
            color: white;
        }
        /* 各場所に応じた色設定 */
        .location-radio-group input[type="radio"][value="hand"]:checked + label { background-color: #3b82f6; border-color: #2563eb; } /* blue-500 */
        .location-radio-group input[type="radio"][value="stage"]:checked + label { background-color: #ef4444; border-color: #dc2626; } /* red-500 */
        .location-radio-group input[type="radio"][value="waiting"]:checked + label { background-color: #6b7280; border-color: #4b5563; } /* gray-500 */
        .location-radio-group input[type="radio"][value="stock"]:checked + label { background-color: #f59e0b; border-color: #d97706; } /* amber-500 */
        .location-radio-group input[type="radio"][value="clock"]:checked + label { background-color: #8b5cf6; border-color: #7c3aed; } /* violet-500 */
        .location-radio-group input[type="radio"][value="level"]:checked + label { background-color: #ec4899; border-color: #db2777; } /* pink-500 */
        .location-radio-group input[type="radio"][value="deck"]:checked + label { background-color: #10b981; border-color: #059669; } /* emerald-500 */

        /* レイアウト修正用CSS */
        .card-info-box {
            /* カード情報全体を格納するボックス */
            display: flex;
            align-items: center;
            flex-shrink: 0;
            /* 修正点: 右マージンを最小限に設定 (空欄を詰める) */
            margin-right: 0.5rem; 
        }
        .card-name-text {
            /* 画像がない場合に表示するカード名テキストのスタイル */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.25rem;
        }
        /* 小画面でボタンがはみ出た場合にスクロールさせる */
        .location-radio-group {
            overflow-x: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .location-radio-group::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">ヴァイス 一人回しツール</h1>
            <p class="text-sm text-gray-600 mt-1">WS用</p>
        </header>

        <!-- リセットとシャッフルボタンを操作パネルの外に移動 -->
        <div class="mb-4 flex justify-end gap-2">
            <button id="shuffle-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 text-sm rounded-lg shadow-md transition-colors">
                山札シャッフル
            </button>
            <button id="reset-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1.5 px-3 text-sm rounded-lg shadow-md transition-colors">
                リセット
            </button>
        </div>

        <!-- 操作パネル (Sticky Header) - ボタンとカウンターを小さく調整 -->
        <div class="bg-white p-4 rounded-lg shadow-md sticky top-0 z-10">
            <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-4">
                <!-- 1. ドロー -->
                <button id="draw-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-1.5 px-3 text-sm rounded-lg transition-colors">
                    ドロー
                </button>
                <!-- 2. 手札ソート表示 -->
                <button id="sort-hand-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1.5 px-3 text-sm rounded-lg transition-colors">
                    ソート
                </button>
                <!-- 3. ダメージボタン -->
                <button id="damage-2-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1.5 px-3 text-sm rounded-lg transition-colors" data-damage="2">
                    2
                </button>
                <button id="damage-3-button" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-1.5 px-3 text-sm rounded-lg transition-colors" data-damage="3">
                    3
                </button>
                <!-- 4. レベルアップボタン -->
                <button id="level-up-button" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-1.5 px-3 text-sm rounded-lg transition-colors">
                    レベル
                </button>
            </div>
            <!-- カウンター - 幅と高さを狭く調整 -->
            <div id="counters" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-7 gap-1 sm:gap-2 text-center">
                
                <!-- p-1.5 から p-1 に、text-lg sm:text-xl から text-base に縮小 -->
                <div class="bg-blue-100 text-blue-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="hand">
                    <div class="text-xs font-medium">手札</div>
                    <span id="count-hand" class="text-base font-bold">0</span>
                </div>
                <div class="bg-red-100 text-red-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="stage">
                    <div class="text-xs font-medium">舞台</div>
                    <span id="count-stage" class="text-base font-bold">0</span>
                </div>
                <div class="bg-gray-200 text-gray-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="waiting">
                    <div class="text-xs font-medium">控室</div>
                    <span id="count-waiting" class="text-base font-bold">0</span>
                </div>
                <div class="bg-amber-100 text-amber-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="stock">
                    <div class="text-xs font-medium">ストック</div>
                    <span id="count-stock" class="text-base font-bold">0</span>
                </div>
                <div class="bg-violet-100 text-violet-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="clock">
                    <div class="text-xs font-medium">クロック</div>
                    <span id="count-clock" class="text-base font-bold">0</span>
                </div>
                <div class="bg-pink-100 text-pink-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="level">
                    <div class="text-xs font-medium">レベル</div>
                    <span id="count-level" class="text-base font-bold">0</span>
                </div>
                <div class="bg-emerald-100 text-emerald-800 p-1 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" data-location="deck">
                    <div class="text-xs font-medium">山札</div>
                    <span id="count-deck" class="text-base font-bold">0</span>
                </div>
            </div>
        </div>
        
        <!-- メッセージ/エラー表示エリア (ダメージ処理結果表示用) -->
        <div id="status-message" class="hidden p-3 mb-4 rounded-lg font-semibold transition-opacity duration-300"></div>

        <!-- デッキリスト - カード行を狭く調整 -->
        <div id="deck-list-container" class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <!-- カードはここに動的に生成されます -->
        </div>

        <!-- デッキリスト入力エリア (最下部) -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-2">デッキリスト入力</h2>
            <p class="text-sm text-gray-600 mb-2">
                以下の形式(ヘッダー行を含む)でデッキリストを貼り付けて、「デッキを読み込む」ボタンを押してください。<br>
                <code class="text-xs bg-gray-200 p-1 rounded">カード番号,枚数,カード名,レベル,コスト,種類</code>
            </p>
            <textarea id="deck-input" class="w-full h-40 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="ここにデッキリスト(CSV形式)を貼り付け..."></textarea>
            <button id="load-deck-button" class="mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                デッキを読み込む
            </button>
        </div>
    </div>

    <!-- モーダルオーバーレイ -->
    <div id="card-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12 max-w-lg max-h-[90vh] overflow-y-auto transform transition-all">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">カードリスト</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-semibold leading-none">&times;</button>
            </div>
            <div id="modal-content" class="space-y-2">
                <!-- カードリストはここに挿入される -->
            </div>
            <div class="mt-4 text-sm text-gray-600">
                ※このリストの順番は、ゲーム内の配置順とは必ずしも一致しません。
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // [1] デフォルトのデッキデータを設定 (ユーザー指定のGIMリストに更新)
            const deckDataCSV = `カード番号,枚数,カード名,レベル,コスト,種類
GIM/W124-010,1,仮装狂騒曲 篠澤 広,3,2,キャラ
GIM/W124-070b,2,ツキノカメ 秦谷美鈴,3,2,キャラ
GIM/W124-071a,4,アイヴイ 月村手毬,3,2,キャラ
GIM/W124-052,1,アナザーアイドル'24夏 花海咲季,2,1,キャラ
GIM/W124-059,1,憧れを目指して 倉本千奈,2,1,キャラ
GIM/W124-007,3,世界一可愛い私 藤田ことね,1,0,キャラ
GIM/W124-035b,1,Feel Jewel Dream 有村麻央,1,0,キャラ
GIM/W124-036a,4,Boom Boom Pow 花海咲季,1,0,キャラ
GIM/W124-041,2,clumsy trick 姫崎莉波,1,0,キャラ
GIM/W124-042,1,冠菊 花海咲季,1,0,キャラ
GIM/W124-002a,4,Yellow Big Bang！ 藤田ことね,0,0,キャラ
GIM/W124-015,2,アナザーアイドル'24夏 藤田ことね,0,0,キャラ
GIM/W124-038,4,Fighting My Way 花海咲季,0,0,キャラ
GIM/W124-040,2,会長、準備は万端です 十王星南,0,0,キャラ
GIM/W124-045,3,君と出会い、夢に翔ける 花海咲季,0,0,キャラ
GIM/W124-073,4,Luna say maybe 月村手毬,0,0,キャラ
GIM/W124-088,3,君と出会い、夢に翔ける 月村手毬,0,0,キャラ
GIM/W124-064,4,お姉ちゃんに任せなさい！,0,0,クライマックス
GIM/W124-098,4,何やってるんだろう、,0,0,クライマックス`;

            const locations = [
                { id: 'hand', name: '手札' },
                { id: 'stage', name: '舞台' },
                { id: 'waiting', name: '控室' },
                { id: 'stock', name: 'スト' },
                { id: 'clock', name: 'クロ' },
                { id: 'level', name: 'レベ' },
                { id: 'deck', name: '山札' }
            ];

            let fullDeck = [];
            // DOM要素の取得
            const deckListContainer = document.getElementById('deck-list-container');
            const shuffleButton = document.getElementById('shuffle-button');
            const drawButton = document.getElementById('draw-button'); 
            const resetButton = document.getElementById('reset-button'); 
            const loadDeckButton = document.getElementById('load-deck-button');
            const sortHandButton = document.getElementById('sort-hand-button'); 
            const levelUpButton = document.getElementById('level-up-button');
            const deckInput = document.getElementById('deck-input');
            const statusMessage = document.getElementById('status-message'); 
            
            // モーダル関連要素の取得
            const cardModal = document.getElementById('card-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const closeModalButton = document.getElementById('close-modal');
            const counterElements = document.querySelectorAll('#counters > div[data-location]'); 
            
            // --- Helper Functions ---
            
            // ステータスメッセージ表示
            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                // スタイルリセット
                statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
                statusMessage.classList.add('opacity-100');

                // スタイル設定
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'text-red-800');
                } else { // info
                    statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                }

                // 5秒後にメッセージを消す
                setTimeout(() => {
                    statusMessage.classList.remove('opacity-100');
                    statusMessage.classList.add('hidden');
                }, 5000);
            }
            
            /**
             * カード番号から画像URLを生成する (GIM対応)
             */
            function createCardImageUrl(cardCode) {
                // [2] GIMとUMAのプレフィックスに対応
                if (!cardCode || !(cardCode.startsWith('UMA/') || cardCode.startsWith('GIM/'))) {
                    return null;
                }
                
                const parts = cardCode.split('/'); 
                if (parts.length < 2) return null;
                
                const seriesPrefix = parts[0].toLowerCase(); // "uma" or "gim"
                const fullCardId = parts[1]; 
                
                // シリーズプレフィックスに基づいてサブディレクトリ文字を決定
                let subDirectoryChar = '';
                if (seriesPrefix === 'uma') {
                    subDirectoryChar = 'u';
                } else if (seriesPrefix === 'gim') {
                    subDirectoryChar = 'g';
                } else {
                    return null; 
                }
                
                if (!fullCardId.includes('-')) return null;

                const idParts = fullCardId.split('-'); 
                if (idParts.length < 2) return null; 

                const setCode = idParts[0].toLowerCase(); 
                const cardSuffix = idParts[1].toLowerCase(); 

                const directoryName = seriesPrefix + "_" + setCode; 
                const fileName = directoryName + "_" + cardSuffix + ".png";
                
                const baseUrl = 'https://ws-tcg.com/wordpress/wp-content/images/cardlist/';
                
                // 決定したサブディレクトリ文字を使ってURLを構築
                return baseUrl + subDirectoryChar + '/' + directoryName + '/' + fileName;
            }

            // --- LocalStorage操作 ---

            // 現在の状態をLocalStorageに保存
            function saveState() {
                const cardLocations = [];
                const cardRows = deckListContainer.children;
                
                Array.from(cardRows).forEach(row => {
                    const cardId = row.dataset.cardId;
                    const checkedRadio = row.querySelector('input[type="radio"]:checked');
                    if (checkedRadio) {
                        cardLocations.push({
                            id: cardId,
                            location: checkedRadio.value
                        });
                    }
                });

                const state = {
                    deckCsv: deckInput.value,
                    cardLocations: cardLocations
                };

                try {
                    localStorage.setItem('wsToolState', JSON.stringify(state));
                } catch (e) {
                    console.error("Could not save state to LocalStorage:", e);
                }
            }

            // LocalStorageから状態を読み込み、復元を試みる
            function loadState() {
                try {
                    const savedState = localStorage.getItem('wsToolState');
                    if (!savedState) {
                        return false; 
                    }

                    const state = JSON.parse(savedState);
                    
                    // 1. デッキCSVを復元し、カードリストを再生成
                    deckInput.value = state.deckCsv || deckDataCSV.trim();
                    loadDeckFromTextarea(false); 

                    // 2. カードの場所を復元
                    if (state.cardLocations && state.cardLocations.length > 0) {
                        const locationMap = new Map(state.cardLocations.map(cl => [cl.id.toString(), cl.location]));
                        
                        Array.from(deckListContainer.children).forEach(row => {
                            const cardId = row.dataset.cardId;
                            const savedLocation = locationMap.get(cardId);
                            
                            if (savedLocation) {
                                const targetRadio = row.querySelector(`input[value="${savedLocation}"]`);
                                if (targetRadio) {
                                    targetRadio.checked = true;
                                }
                            } else {
                                row.querySelector('input[value="deck"]').checked = true;
                            }
                        });

                        // 3. カウンターを更新
                        updateCounters();
                        showStatus('前回終了時の状態を復元しました。', 'info');
                        return true;
                    }

                } catch (e) {
                    console.error("Error loading state from LocalStorage:", e);
                }
                return false;
            }

            // 1. デッキデータの解析と生成
            function parseDeckData(csv) {
                try {
                    const lines = csv.trim().split('\n').slice(1); 
                    const deck = [];
                    let cardId = 0;
                    if (lines.length === 0) return [];

                    lines.forEach((line, index) => {
                        const parts = line.split(',');
                        if (parts.length < 6) {
                            console.warn(`Skipping malformed line ${index + 2}: ${line}`);
                            return; 
                        }
                        // カード番号 (CardCode) を取得
                        const [cardCode, countStr, name, level, cost, type] = parts;
                        const count = parseInt(countStr, 10);

                        if (isNaN(count) || count <= 0) {
                            console.warn(`Skipping line with invalid count ${index + 2}: ${line}`);
                            return;
                        }

                        for (let i = 0; i < count; i++) {
                            deck.push({
                                id: cardId++, 
                                cardCode: cardCode.trim(), 
                                name: name.trim(),
                                level: level.trim(), 
                                type: type.trim() 
                            });
                        }
                    });
                    return deck;
                } catch (error) {
                    console.error("Error parsing deck data:", error);
                    return []; 
                }
            }

            // 2. DOMの描画
            f